(()=>{"use strict";var e={430:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};const o=n(591);const handler=(e,t)=>i(void 0,void 0,void 0,(function*(){if(e.body.event!=="integrations.ready"){return{statusCode:422,body:'This integration only supports the "integrations.ready" event'}}const n=yield t.integration();const i="https://production.rutterapi.com";const{access_token:s,connection_id:r,is_ready:a}=(yield t.got(`${i}/item/public_token/exchange`,{responseType:"json",json:{client_id:process.env.RUTTER_CLIENT_ID,secret:process.env.RUTTER_SECRET_ID,public_token:n.config.publicToken},method:"post"})).body;n.setExternalId(r);if(!a){return{statusCode:202,body:"Product syncing will begin when the external service is ready"}}const d={responseType:"json",searchParams:{access_token:s},username:process.env.RUTTER_CLIENT_ID,password:process.env.RUTTER_SECRET_ID,prefixUrl:i};const c=n.template.code;const u=[];const l={products:[],categories:[]};let p=[];let v=null;const _=(yield t.store.get("idMap"))||{};do{const e=v?`?cursor=${v}`:"";try{({products:p,next_cursor:v}=(yield t.got(`products${e}`,d)).body)}catch(e){console.log(e,e.response.body);throw e}if(!p){break}p.filter((e=>!Object.values(_).find((({integration_id:t})=>t===e.id)))).map((e=>{u.push(saveProduct(e,t).then((t=>{_[t.id]={[`${c}_id`]:e.platform_id,integration_id:e.id};return t})));l.products.push(e)}))}while(v&&p&&p.length!==0);const f=yield Promise.all(u);t.store.set("idMap",_);if(u.length===0){return{statusCode:200,body:"All products have already been synced"}}return{statusCode:201,body:JSON.stringify({message:`${o.default[c].label} sync completed!`,product_count:u.length,product_ids:f.map((({id:e})=>e))})}}));function convertProduct(e){var t,n,i,o,s,r;const a={product:{name:e.name,description:(e===null||e===void 0?void 0:e.description)||null,price:0,active:e.status==="active"},assets:[]};if(e.variants.length===1){return Object.assign(Object.assign({},a),{product:Object.assign(Object.assign({},a.product),{sku:((t=e.variants[0])===null||t===void 0?void 0:t.sku)||null,price:((n=e.variants[0])===null||n===void 0?void 0:n.price)||0,quantity:((o=(i=e.variants[0])===null||i===void 0?void 0:i.inventory)===null||o===void 0?void 0:o.total_count)||null}),collect:{shipping:(s=e.variants[0])===null||s===void 0?void 0:s.requires_shipping},delivery:{enabled:{shipping_native_v1:(r=e===null||e===void 0?void 0:e.variants[0])===null||r===void 0?void 0:r.requires_shipping}}})}const d=e.variants.reduce(((e,t)=>{t.option_values.forEach((({name:t,value:n})=>{let i=e.findIndex((e=>e.name===t));if(i===-1){i=e.length;e.push({name:t,options:[]})}if(!e[i].options.find((e=>e.description===n))){e[i].options.push({description:n})}}));return e}),[]);return Object.assign(Object.assign({},a),{collect:{shipping:e.variants.some((e=>e.requires_shipping===true))},delivery:{enabled:{shipping_native_v1:e.variants.some((e=>e.requires_shipping===true))}},variant_groups:d})}function saveProduct(e,t){var n;return i(this,void 0,void 0,(function*(){const o=convertProduct(e);if(((n=e.images)===null||n===void 0?void 0:n.length)>0){o.assets=(yield Promise.all(e.images.map((e=>i(this,void 0,void 0,(function*(){return(yield t.api.post("v1/assets",{filename:e.src.substring(e.src.lastIndexOf("/")+1),url:e.src})).id})))))).map((e=>({id:e})))}const s=yield t.api.post("v1/products",o);if(e.variants.length<=1){return s}const r=e.variants.map((e=>{var n;const i=e.option_values.map((({name:e,value:t})=>{const n=s.variant_groups.find((({name:t})=>t===e));return n.options.find((({name:e})=>e===t)).id}));let o=(n=e.inventory)===null||n===void 0?void 0:n.total_count;if(typeof o!=="number"){o=undefined}else if(o<0){o=0}return t.api.post(`v1/products/${s.id}/variants`,{sku:e.sku,price:e.price,inventory:o,options:i})}));yield Promise.all(r);return s}))}e.exports=handler},591:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.default={shopify:{platform:"SHOPIFY",label:"Shopify"},magento:{platform:"MAGENTO",label:"Magento"}}}};var t={};function __nccwpck_require__(n){var i=t[n];if(i!==undefined){return i.exports}var o=t[n]={exports:{}};var s=true;try{e[n].call(o.exports,o,o.exports,__nccwpck_require__);s=false}finally{if(s)delete t[n]}return o.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var n=__nccwpck_require__(430);module.exports=n})();