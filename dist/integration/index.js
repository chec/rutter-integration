(()=>{"use strict";var e={430:function(e){var t=this&&this.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,o){function fulfilled(e){try{step(i.next(e))}catch(e){o(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){o(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};const n=[];const handler=(e,i)=>t(void 0,void 0,void 0,(function*(){if(e.body.event!=="integrations.ready"){return{statusCode:422,body:'This integration only supports the "integrations.ready" event'}}const t=yield i.integration();const o=t.template.code;const s=[];const r={products:[],categories:[]};const a=yield getConfig(i);let c=[];let u=null;do{const e=u?`?cursor=${u}`:"";({products:c,next_cursor:u}=(yield i.got(`products${e}`,a)).body);if(!c){break}c.map((e=>{s.push(saveProduct(e,i,o));r.products.push(e)}))}while(u&&c&&c.length!==0);if(n.includes(o)){}const d=yield Promise.all(s);return{statusCode:201,body:JSON.stringify({message:"Shopify sync completed!",product_count:s.length,product_ids:d.map((({id:e})=>e))})}}));function getConfig(e){return t(this,void 0,void 0,(function*(){const t="https://production.rutterapi.com";const n=yield e.integration();const i=yield e.got(`${t}/item/public_token/exchange`,{json:{client_id:process.env.RUTTER_CLIENT_ID,secret:process.env.RUTTER_SECRET_ID,public_token:n.config.publicToken},method:"post"}).json();return{responseType:"json",searchParams:{access_token:i.access_token},username:process.env.RUTTER_CLIENT_ID,password:process.env.RUTTER_SECRET_ID,prefixUrl:t}}))}function convertProduct(e,t){var n,i,o,s,r,a;const c={product:{name:e.name,description:(e===null||e===void 0?void 0:e.description)||null,price:0,active:e.status==="active"},assets:[]};if(e.variants.length===1){return Object.assign(Object.assign({},c),{product:Object.assign(Object.assign({},c.product),{sku:((n=e.variants[0])===null||n===void 0?void 0:n.sku)||null,price:((i=e.variants[0])===null||i===void 0?void 0:i.price)||0,quantity:((s=(o=e.variants[0])===null||o===void 0?void 0:o.inventory)===null||s===void 0?void 0:s.total_count)||null,meta:{[`${t}_id`]:e.platform_id,integration_id:e.id}}),collect:{shipping:(r=e.variants[0])===null||r===void 0?void 0:r.requires_shipping},delivery:{enabled:{shipping_native_v1:(a=e===null||e===void 0?void 0:e.variants[0])===null||a===void 0?void 0:a.requires_shipping}}})}const u=e.variants.reduce(((e,t)=>{t.option_values.forEach((({name:t,value:n})=>{let i=e.findIndex((e=>e.name===t));if(i===-1){i=e.length;e.push({name:t,options:[]})}if(!e[i].options.find((e=>e.description===n))){e[i].options.push({description:n})}}));return e}),[]);return Object.assign(Object.assign({},c),{collect:{shipping:e.variants.some((e=>e.requires_shipping===true))},delivery:{enabled:{shipping_native_v1:e.variants.some((e=>e.requires_shipping===true))}},variant_groups:u})}function saveProduct(e,n,i){var o;return t(this,void 0,void 0,(function*(){const s=convertProduct(e,i);if(((o=e.images)===null||o===void 0?void 0:o.length)>0){s.assets=(yield Promise.all(e.images.map((e=>t(this,void 0,void 0,(function*(){return(yield n.api.post("v1/assets",{filename:e.src.substring(e.src.lastIndexOf("/")+1),url:e.src})).id})))))).map((e=>({id:e})))}const r=yield n.api.post("v1/products",s);if(e.variants.length<=1){return r}const a=e.variants.map((e=>{var t;const i=e.option_values.map((({name:e,value:t})=>{const n=r.variant_groups.find((({name:t})=>t===e));return n.options.find((({name:e})=>e===t)).id}));let o=(t=e.inventory)===null||t===void 0?void 0:t.total_count;if(typeof o!=="number"){o=undefined}else if(o<0){o=0}return n.api.post(`v1/products/${r.id}/variants`,{sku:e.sku,price:e.price,inventory:o,options:i})}));yield Promise.all(a);return r}))}e.exports=handler}};var t={};function __nccwpck_require__(n){var i=t[n];if(i!==undefined){return i.exports}var o=t[n]={exports:{}};var s=true;try{e[n].call(o.exports,o,o.exports,__nccwpck_require__);s=false}finally{if(s)delete t[n]}return o.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var n=__nccwpck_require__(430);module.exports=n})();