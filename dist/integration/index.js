(()=>{"use strict";var e={430:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){function adopt(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?i(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};const o=i(591);const handler=(e,t)=>n(void 0,void 0,void 0,(function*(){if(e.body.event!=="integrations.ready"){return{statusCode:422,body:'This integration only supports the "integrations.ready" event'}}const i=yield t.integration();const n=i.template.code;const r=[];const s={products:[],categories:[]};const a=yield getConfig(t);let u=[];let d=null;const c=(yield t.store.get("idMap"))||{};do{const e=d?`?cursor=${d}`:"";({products:u,next_cursor:d}=(yield t.got(`products${e}`,a)).body);if(!u){break}u.filter((e=>!Object.values(c).find((({integration_id:t})=>t===e.id)))).map((e=>{r.push(saveProduct(e,t).then((t=>{c[t.id]={[`${n}_id`]:e.platform_id,integration_id:e.id};return t})));s.products.push(e)}))}while(d&&u&&u.length!==0);const l=yield Promise.all(r);t.store.set("idMap",c);if(r.length===0){return{statusCode:200,body:"All products have already been synced"}}return{statusCode:201,body:JSON.stringify({message:`${o.default[n].label} sync completed!`,product_count:r.length,product_ids:l.map((({id:e})=>e))})}}));function getConfig(e){return n(this,void 0,void 0,(function*(){const t="https://production.rutterapi.com";const i=yield e.integration();const n=yield e.got(`${t}/item/public_token/exchange`,{json:{client_id:process.env.RUTTER_CLIENT_ID,secret:process.env.RUTTER_SECRET_ID,public_token:i.config.publicToken},method:"post"}).json();return{responseType:"json",searchParams:{access_token:n.access_token},username:process.env.RUTTER_CLIENT_ID,password:process.env.RUTTER_SECRET_ID,prefixUrl:t}}))}function convertProduct(e){var t,i,n,o,r,s;const a={product:{name:e.name,description:(e===null||e===void 0?void 0:e.description)||null,price:0,active:e.status==="active"},assets:[]};if(e.variants.length===1){return Object.assign(Object.assign({},a),{product:Object.assign(Object.assign({},a.product),{sku:((t=e.variants[0])===null||t===void 0?void 0:t.sku)||null,price:((i=e.variants[0])===null||i===void 0?void 0:i.price)||0,quantity:((o=(n=e.variants[0])===null||n===void 0?void 0:n.inventory)===null||o===void 0?void 0:o.total_count)||null}),collect:{shipping:(r=e.variants[0])===null||r===void 0?void 0:r.requires_shipping},delivery:{enabled:{shipping_native_v1:(s=e===null||e===void 0?void 0:e.variants[0])===null||s===void 0?void 0:s.requires_shipping}}})}const u=e.variants.reduce(((e,t)=>{t.option_values.forEach((({name:t,value:i})=>{let n=e.findIndex((e=>e.name===t));if(n===-1){n=e.length;e.push({name:t,options:[]})}if(!e[n].options.find((e=>e.description===i))){e[n].options.push({description:i})}}));return e}),[]);return Object.assign(Object.assign({},a),{collect:{shipping:e.variants.some((e=>e.requires_shipping===true))},delivery:{enabled:{shipping_native_v1:e.variants.some((e=>e.requires_shipping===true))}},variant_groups:u})}function saveProduct(e,t){var i;return n(this,void 0,void 0,(function*(){const o=convertProduct(e);if(((i=e.images)===null||i===void 0?void 0:i.length)>0){o.assets=(yield Promise.all(e.images.map((e=>n(this,void 0,void 0,(function*(){return(yield t.api.post("v1/assets",{filename:e.src.substring(e.src.lastIndexOf("/")+1),url:e.src})).id})))))).map((e=>({id:e})))}const r=yield t.api.post("v1/products",o);if(e.variants.length<=1){return r}const s=e.variants.map((e=>{var i;const n=e.option_values.map((({name:e,value:t})=>{const i=r.variant_groups.find((({name:t})=>t===e));return i.options.find((({name:e})=>e===t)).id}));let o=(i=e.inventory)===null||i===void 0?void 0:i.total_count;if(typeof o!=="number"){o=undefined}else if(o<0){o=0}return t.api.post(`v1/products/${r.id}/variants`,{sku:e.sku,price:e.price,inventory:o,options:n})}));yield Promise.all(s);return r}))}e.exports=handler},591:(e,t)=>{Object.defineProperty(t,"__esModule",{value:true});t.default={shopify:{platform:"SHOPIFY",label:"Shopify"}}}};var t={};function __nccwpck_require__(i){var n=t[i];if(n!==undefined){return n.exports}var o=t[i]={exports:{}};var r=true;try{e[i].call(o.exports,o,o.exports,__nccwpck_require__);r=false}finally{if(r)delete t[i]}return o.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var i=__nccwpck_require__(430);module.exports=i})();